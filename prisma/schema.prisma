// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String      @id @default(cuid())
  email             String      @unique
  name              String?
  authProvider      String?     // 'google', 'github', 'email'
  authId            String?
  
  // Subscription
  subscriptionTier  String      @default("free")
  subscription      Subscription?
  
  // Relations
  dodoCustomer      DodoCustomer?
  payments          Payment[]
  invoices          Invoice[]
  checkoutSessions  CheckoutSession[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  lastLoginAt       DateTime?
}

model DodoCustomer {
  id                String      @id @default(cuid())
  userId            String      @unique
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dodoCustomerId    String      @unique  // e.g., cus_xxxxx
  email             String?
  name              String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model Subscription {
  id                String      @id @default(cuid())
  userId            String      @unique
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dodoSubId         String      @unique  // e.g., sub_xxxxx
  planSlug          String      // 'starter', 'pro', 'premium'
  productId         String
  amountCents       Int
  status            String      @default("pending")  // pending, active, on_hold, cancelled
  
  // Billing dates
  startedAt         DateTime?
  nextBillingDate   DateTime?
  cancelledAt       DateTime?
  
  // Relations
  payments          Payment[]
  invoices          Invoice[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model Payment {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subscriptionId    String?
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  
  dodoPaymentId     String      @unique
  amountCents       Int
  status            String      @default("pending")  // pending, succeeded, failed
  
  processedAt       DateTime?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model Invoice {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subscriptionId    String?
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  
  invoiceNumber     String      @unique
  totalCents        Int
  status            String      @default("issued")  // issued, paid
  
  issuedAt          DateTime    @default(now())
  paidAt            DateTime?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model WebhookEvent {
  id                String      @id @default(cuid())
  dodoWebhookId     String      @unique
  eventType         String
  status            String      @default("received")  // received, completed, failed
  payload           Json
  
  processedAt       DateTime?
  errorMessage      String?
  
  createdAt         DateTime    @default(now())
}

model CheckoutSession {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dodoSessionId     String      @unique
  planSlug          String
  status            String      @default("pending")  // pending, completed, expired
  
  checkoutUrl       String
  expiresAt         DateTime
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}